name: gitlab-to-forgejo

services:
  db:
    image: postgres:16-alpine
    environment:
      POSTGRES_DB: forgejo
      POSTGRES_USER: forgejo
      POSTGRES_PASSWORD: forgejo
    volumes:
      - forgejo-db:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U forgejo -d forgejo"]
      interval: 2s
      timeout: 5s
      retries: 30

  forgejo:
    image: codeberg.org/forgejo/forgejo:14.0.1
    depends_on:
      db:
        condition: service_healthy
    environment:
      USER_UID: "1000"
      USER_GID: "1000"

      FORGEJO__database__DB_TYPE: postgres
      FORGEJO__database__HOST: db:5432
      FORGEJO__database__NAME: forgejo
      FORGEJO__database__USER: forgejo
      FORGEJO__database__PASSWD: forgejo
      FORGEJO__database__SSL_MODE: disable

      FORGEJO__security__INSTALL_LOCK: "true"
      FORGEJO__service__DISABLE_REGISTRATION: "true"

      # Migration performance knobs (override via env when starting Compose)
      FORGEJO__queue__TYPE: "${FORGEJO_QUEUE_TYPE:-channel}"
      FORGEJO__indexer__ISSUE_INDEXER_TYPE: "${FORGEJO_ISSUE_INDEXER_TYPE:-db}"

      FORGEJO__server__DOMAIN: localhost
      FORGEJO__server__ROOT_URL: http://localhost:${FORGEJO_HTTP_PORT:-3000}/
      FORGEJO__server__SSH_DOMAIN: localhost
      FORGEJO__server__SSH_PORT: "${FORGEJO_SSH_PORT:-2222}"
    volumes:
      - forgejo-data:/data
    ports:
      - "${FORGEJO_HTTP_PORT:-3000}:3000"
      - "${FORGEJO_SSH_PORT:-2222}:22"

volumes:
  forgejo-data:
  forgejo-db:

networks:
  default:
    ipam:
      config:
        - subnet: ${FORGEJO_COMPOSE_SUBNET:-10.77.77.0/24}
